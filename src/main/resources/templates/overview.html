<h2 class="text-2xl font-semibold mb-4">Обзор расходов</h2>
<div class="top-spendings-container">
    <h3 class="text-xl mb-2 text-center">Топ 3 расходов за год:</h3>
    <div class="grid grid-cols-3 gap-6" id="top3spendings">
        <div class="p-4 bg-neutral-200 rounded-md">
            <h3 class="text-xl">Запчасти</h3>
            <p class="text-lg">2 400,00 ₽</p>
        </div>

        <div class="p-4 bg-neutral-200 rounded-md">
            <h3 class="text-xl">Топливо</h3>
            <p class="text-lg">1 615,15 ₽</p>
        </div>

        <div class="p-4 bg-neutral-200 rounded-md">
            <h3 class="text-xl">Услуги</h3>
            <p class="text-lg">100,15 ₽</p>
        </div>
    </div>
</div>

<div class="mt-8">
    <h3 class="text-xl mb-4">Тренды расходов</h3>
    <canvas id="expensesChart" width="600" height="200" class="rounded-md"></canvas>
</div>

<script>
    function updateExpensesChart(expenses) {
        const monthlyExpenses = Array(12).fill(0); // Array for keep expenses by month

        expenses.forEach(expense => {
            const month = new Date(expense.date).getMonth(); // get month (0-11)
            monthlyExpenses[month] += expense.amount; // summ expenses by month
        });

        const data = {
            labels: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
            datasets: [{
                label: 'Расходы на содержание автомобиля (₽)',
                data: monthlyExpenses,
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
            }]
        };

        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Сумма (₽)' }
                    },
                    x: {
                        title: { display: true, text: 'Месяцы' }
                    }
                }
            }
        };

        // init chart
        new Chart(document.getElementById('expensesChart'), config);
    }

    function printTop3SpendingYear(expenses) {
        // groupBy partType
        const groupedSpendings = expenses.reduce((acc, spending) => {
            const { partType, partTypeDescription, amount } = spending;

            if (!acc[partType]) {
                acc[partType] = {
                    partType,
                    partTypeDescription,
                    summ: 0
                };
            }

            acc[partType].summ += amount;
            return acc;
        }, {});

        // Sort array by desc summ
        const sortedSpendings = Object.values(groupedSpendings).sort((a, b) => b.summ - a.summ);

        // print top 3 spending
        const top3Spendings = $('#top3spendings');
        top3Spendings.html('');

        sortedSpendings.slice(0, 3).forEach(spending => {
            top3Spendings.append(`
                <div class="p-4 bg-neutral-200 rounded-md">
                    <h3 class="text-xl">${spending.partTypeDescription}</h3>
                    <p class="text-lg">${formatCurrency(spending.summ)}</p>
                </div>
            `);
        });
    }

    const currentYear = new Date().getFullYear();
    const startOfYear = `${currentYear}-01-01`;
    const endOfYear = `${currentYear}-12-31`;

    // get data spendings by current year
    fetchSpendingData(startOfYear, endOfYear)
        .then(data => {
            printTop3SpendingYear(data);
            updateExpensesChart(data);
        })
        .catch(error => {
            console.error('Произошла ошибка:', error);
        });
</script>